<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zarraz Cube App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117;
            color: #c9d1d9;
            overflow: hidden;
        }
        canvas {
            display: block;
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="fixed inset-0 flex flex-col items-center justify-center p-4 z-10">
        <h1 class="text-3xl sm:text-4xl md:text-5xl font-bold text-center mb-4 md:mb-6 leading-tight">Zarraz Cube</h1>
        <p class="text-sm md:text-base text-center text-gray-400 mb-8 max-w-lg">
            Create an account or log in to save and load your personal cube state.
        </p>

        <!-- Container for messages -->
        <div id="messageBox" class="bg-blue-800 bg-opacity-30 border-l-4 border-blue-500 text-blue-200 p-4 rounded-lg hidden mb-6 transition-all duration-300 w-full max-w-md" role="alert">
            <p id="messageText" class="font-medium"></p>
        </div>

        <!-- Authentication Form - Initially visible -->
        <div id="authForm" class="w-full max-w-md flex flex-col gap-4 p-6 bg-gray-800 rounded-xl shadow-lg">
            <input type="email" id="emailInput" placeholder="Email" class="p-3 rounded-lg bg-gray-700 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-indigo-500">
            <input type="password" id="passwordInput" placeholder="Password" class="p-3 rounded-lg bg-gray-700 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-indigo-500">
            <div class="flex flex-col sm:flex-row gap-3">
                <button id="signUpButton" class="w-full bg-indigo-600 text-white font-semibold py-3 px-6 rounded-lg shadow-lg hover:bg-indigo-700 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    Sign Up
                </button>
                <button id="signInButton" class="w-full bg-green-600 text-white font-semibold py-3 px-6 rounded-lg shadow-lg hover:bg-green-700 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-green-500">
                    Sign In
                </button>
            </div>
        </div>

        <!-- App Controls - Hidden until authenticated -->
        <div id="appControls" class="w-full max-w-md flex-col items-center gap-4 hidden">
            <div class="flex flex-col sm:flex-row gap-3 sm:gap-4 w-full justify-center">
                <button id="saveButton" class="w-full sm:w-1/2 bg-indigo-600 text-white font-semibold py-3 px-6 rounded-lg shadow-lg hover:bg-indigo-700 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    Save Cube State
                </button>
                <button id="loadButton" class="w-full sm:w-1/2 bg-green-600 text-white font-semibold py-3 px-6 rounded-lg shadow-lg hover:bg-green-700 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-green-500">
                    Load Cube State
                </button>
            </div>
            <button id="signOutButton" class="mt-4 w-full bg-red-600 text-white font-semibold py-3 px-6 rounded-lg shadow-lg hover:bg-red-700 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-red-500">
                Sign Out
            </button>
        </div>
    </div>

    <!-- The Canvas for the 3D cube -->
    <canvas id="canvas"></canvas>

    <script type="module">
        // IMPORTANT: Use the global variables provided by the Canvas environment.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables for Firebase services and user ID
        let app;
        let db;
        let auth;
        let userId = null;

        // UI elements
        const saveButton = document.getElementById('saveButton');
        const loadButton = document.getElementById('loadButton');
        const signOutButton = document.getElementById('signOutButton');
        const signUpButton = document.getElementById('signUpButton');
        const signInButton = document.getElementById('signInButton');
        const emailInput = document.getElementById('emailInput');
        const passwordInput = document.getElementById('passwordInput');
        const messageBox = document.getElementById('messageBox');
        const messageText = document.getElementById('messageText');
        const authForm = document.getElementById('authForm');
        const appControls = document.getElementById('appControls');
        const canvas = document.getElementById('canvas');

        // --- Three.js Setup (same as before) ---
        let scene, camera, renderer, cube;
        let isDragging = false;
        let previousMousePosition = { x: 0, y: 0 };

        function initThreeJS() {
            // Scene, Camera, Renderer
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            renderer = new THREE.WebGLRenderer({ canvas: canvas, antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            camera.position.z = 2;

            // Cube geometry, material, and mesh
            const geometry = new THREE.BoxGeometry(1, 1, 1);
            const material = new THREE.MeshNormalMaterial();
            cube = new THREE.Mesh(geometry, material);
            scene.add(cube);

            // Handle window resizing
            window.addEventListener('resize', onWindowResize, false);
            function onWindowResize() {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            }

            // Mouse and touch interaction for cube rotation
            document.addEventListener('mousedown', (e) => { isDragging = true; previousMousePosition.x = e.clientX; previousMousePosition.y = e.clientY; });
            document.addEventListener('mouseup', () => { isDragging = false; });
            document.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                const deltaMove = { x: e.clientX - previousMousePosition.x, y: e.clientY - previousMousePosition.y };
                cube.rotation.y += deltaMove.x * 0.005;
                cube.rotation.x += deltaMove.y * 0.005;
                previousMousePosition.x = e.clientX;
                previousMousePosition.y = e.clientY;
            });
            document.addEventListener('touchstart', (e) => { isDragging = true; const touch = e.touches[0]; previousMousePosition.x = touch.clientX; previousMousePosition.y = touch.clientY; });
            document.addEventListener('touchend', () => { isDragging = false; });
            document.addEventListener('touchmove', (e) => {
                if (!isDragging) return;
                const touch = e.touches[0];
                const deltaMove = { x: touch.clientX - previousMousePosition.x, y: touch.clientY - previousMousePosition.y };
                cube.rotation.y += deltaMove.x * 0.005;
                cube.rotation.x += deltaMove.y * 0.005;
                previousMousePosition.x = touch.clientX;
                previousMousePosition.y = touch.clientY;
            });

            // Animation loop
            function animate() {
                requestAnimationFrame(animate);
                renderer.render(scene, camera);
            }
            animate();
        }

        // --- Firebase Integration and Authentication Logic ---
        function showMessage(text, isError = false) {
            messageText.textContent = text;
            messageBox.classList.remove('hidden');
            if (isError) {
                messageBox.classList.remove('bg-blue-800', 'bg-opacity-30', 'border-blue-500', 'text-blue-200');
                messageBox.classList.add('bg-red-800', 'bg-opacity-30', 'border-red-500', 'text-red-200');
            } else {
                messageBox.classList.remove('bg-red-800', 'bg-opacity-30', 'border-red-500', 'text-red-200');
                messageBox.classList.add('bg-blue-800', 'bg-opacity-30', 'border-blue-500', 'text-blue-200');
            }
            setTimeout(() => {
                messageBox.classList.add('hidden');
            }, 5000);
        }

        async function initializeFirebase() {
            try {
                if (!firebaseConfig) {
                    console.error("Firebase config is not defined. Cannot initialize the app.");
                    showMessage("Error: Firebase config is missing. Cannot initialize.", true);
                    return;
                }
                
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // Use onAuthStateChanged to manage UI based on login state
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        // User is logged in
                        userId = user.uid;
                        authForm.classList.add('hidden');
                        appControls.classList.remove('hidden');
                        showMessage(`Welcome back, ${user.email}!`);
                    } else {
                        // User is logged out
                        userId = null;
                        authForm.classList.remove('hidden');
                        appControls.classList.add('hidden');
                        showMessage("Please sign in or sign up.", false);
                    }
                });

                // Authenticate with the initial token if it exists
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                }
            } catch (error) {
                console.error("Error initializing Firebase:", error);
                showMessage(`Error initializing Firebase: ${error.message}`, true);
            }
        }

        // --- User Authentication Functions ---
        async function signUp() {
            const email = emailInput.value;
            const password = passwordInput.value;
            if (!email || !password) {
                showMessage("Please enter both email and password.", true);
                return;
            }
            try {
                await createUserWithEmailAndPassword(auth, email, password);
                showMessage("Sign up successful! You are now logged in.");
            } catch (error) {
                console.error("Sign up error:", error);
                showMessage(`Sign up failed: ${error.message}`, true);
            }
        }

        async function signIn() {
            const email = emailInput.value;
            const password = passwordInput.value;
            if (!email || !password) {
                showMessage("Please enter both email and password.", true);
                return;
            }
            try {
                await signInWithEmailAndPassword(auth, email, password);
                showMessage("Sign in successful!");
            } catch (error) {
                console.error("Sign in error:", error);
                showMessage(`Sign in failed: ${error.message}`, true);
            }
        }

        async function signOutUser() {
            try {
                await signOut(auth);
                showMessage("You have been signed out.");
            } catch (error) {
                console.error("Sign out error:", error);
                showMessage(`Sign out failed: ${error.message}`, true);
            }
        }

        // --- Firestore Functions ---
        async function saveCubeState() {
            if (!userId) {
                showMessage("You must be logged in to save the cube state.", true);
                return;
            }

            const docId = 'zarraz-state';
            // The path is now private and specific to the authenticated user
            const path = `artifacts/${appId}/users/${userId}/cube-state/${docId}`;
            const docRef = doc(db, path);

            try {
                const rotation = {
                    x: cube.rotation.x,
                    y: cube.rotation.y,
                    z: cube.rotation.z
                };

                await setDoc(docRef, { 
                    rotation, 
                    lastUpdated: new Date() 
                });
                
                console.log(`Cube state saved for user ${userId}.`);
                showMessage("Cube state saved to your account!");
            } catch (e) {
                console.error("Error saving document: ", e);
                showMessage(`Error saving state: ${e.message}`, true);
            }
        }

        async function loadCubeState() {
            if (!userId) {
                showMessage("You must be logged in to load the cube state.", true);
                return;
            }

            const docId = 'zarraz-state';
            const path = `artifacts/${appId}/users/${userId}/cube-state/${docId}`;
            const docRef = doc(db, path);

            try {
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    const rotation = data.rotation;
                    
                    cube.rotation.x = rotation.x;
                    cube.rotation.y = rotation.y;
                    cube.rotation.z = rotation.z;

                    console.log(`Cube state loaded for user ${userId}.`);
                    showMessage("Cube state loaded from your account!");
                } else {
                    showMessage("No saved cube state found for your account.", true);
                    console.log("No saved state found!");
                }
            } catch (e) {
                console.error("Error loading document: ", e);
                showMessage(`Error loading state: ${e.message}`, true);
            }
        }
        
        // Add event listeners for all buttons
        signUpButton.addEventListener('click', signUp);
        signInButton.addEventListener('click', signIn);
        signOutButton.addEventListener('click', signOutUser);
        saveButton.addEventListener('click', saveCubeState);
        loadButton.addEventListener('click', loadCubeState);

        // Run on window load
        window.onload = function() {
            initializeFirebase();
            initThreeJS();
        }
    </script>
</body>
</html>
