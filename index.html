<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zarraz Cube App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117;
            color: #c9d1d9;
            overflow: hidden;
        }
        canvas {
            display: block;
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="fixed inset-0 flex flex-col items-center justify-center p-4 z-10">
        <h1 class="text-3xl sm:text-4xl md:text-5xl font-bold text-center mb-4 md:mb-6 leading-tight">Zarraz Cube</h1>
        <p class="text-sm md:text-base text-center text-gray-400 mb-8 max-w-lg">
            Drag the cube to rotate it. Use the buttons below to save and load its state from the Firebase database.
        </p>

        <!-- Container for messages -->
        <div id="messageBox" class="bg-blue-800 bg-opacity-30 border-l-4 border-blue-500 text-blue-200 p-4 rounded-lg hidden mb-6 transition-all duration-300 w-full max-w-md" role="alert">
            <p id="messageText" class="font-medium"></p>
        </div>

        <div class="flex flex-col sm:flex-row gap-3 sm:gap-4 mt-4 w-full justify-center max-w-md">
            <button id="saveButton" class="w-full sm:w-1/2 bg-indigo-600 text-white font-semibold py-3 px-6 rounded-lg shadow-lg hover:bg-indigo-700 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                Save Cube State
            </button>
            <button id="loadButton" class="w-full sm:w-1/2 bg-green-600 text-white font-semibold py-3 px-6 rounded-lg shadow-lg hover:bg-green-700 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-green-500">
                Load Cube State
            </button>
        </div>
    </div>

    <!-- The Canvas for the 3D cube -->
    <canvas id="canvas"></canvas>

    <script type="module">
        // IMPORTANT: Use the global variables provided by the Canvas environment.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables for Firebase services and user ID
        let app;
        let db;
        let auth;
        let userId = null;

        // UI elements
        const saveButton = document.getElementById('saveButton');
        const loadButton = document.getElementById('loadButton');
        const messageBox = document.getElementById('messageBox');
        const messageText = document.getElementById('messageText');
        const canvas = document.getElementById('canvas');

        // --- Three.js Setup ---
        let scene, camera, renderer, cube;
        let isDragging = false;
        let previousMousePosition = { x: 0, y: 0 };

        function initThreeJS() {
            // Scene, Camera, Renderer
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            renderer = new THREE.WebGLRenderer({ canvas: canvas, antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            camera.position.z = 2;

            // Cube geometry, material, and mesh
            const geometry = new THREE.BoxGeometry(1, 1, 1);
            const material = new THREE.MeshNormalMaterial(); // A simple, clean material
            cube = new THREE.Mesh(geometry, material);
            scene.add(cube);

            // Handle window resizing
            window.addEventListener('resize', onWindowResize, false);
            function onWindowResize() {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            }

            // --- Mouse Interaction ---
            document.addEventListener('mousedown', (e) => {
                isDragging = true;
                previousMousePosition.x = e.clientX;
                previousMousePosition.y = e.clientY;
            });

            document.addEventListener('mouseup', () => {
                isDragging = false;
            });

            document.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                const deltaMove = {
                    x: e.clientX - previousMousePosition.x,
                    y: e.clientY - previousMousePosition.y
                };
                cube.rotation.y += deltaMove.x * 0.005;
                cube.rotation.x += deltaMove.y * 0.005;
                previousMousePosition.x = e.clientX;
                previousMousePosition.y = e.clientY;
            });

            // Touch event listeners for mobile devices
            document.addEventListener('touchstart', (e) => {
                isDragging = true;
                const touch = e.touches[0];
                previousMousePosition.x = touch.clientX;
                previousMousePosition.y = touch.clientY;
            });

            document.addEventListener('touchend', () => {
                isDragging = false;
            });

            document.addEventListener('touchmove', (e) => {
                if (!isDragging) return;
                const touch = e.touches[0];
                const deltaMove = {
                    x: touch.clientX - previousMousePosition.x,
                    y: touch.clientY - previousMousePosition.y
                };
                cube.rotation.y += deltaMove.x * 0.005;
                cube.rotation.x += deltaMove.y * 0.005;
                previousMousePosition.x = touch.clientX;
                previousMousePosition.y = touch.clientY;
            });

            // Animation loop
            function animate() {
                requestAnimationFrame(animate);
                renderer.render(scene, camera);
            }
            animate();
        }

        // --- Firebase Integration ---
        // Function to show messages to the user
        function showMessage(text, isError = false) {
            messageText.textContent = text;
            messageBox.classList.remove('hidden');
            if (isError) {
                messageBox.classList.remove('bg-blue-800', 'bg-opacity-30', 'border-blue-500', 'text-blue-200');
                messageBox.classList.add('bg-red-800', 'bg-opacity-30', 'border-red-500', 'text-red-200');
            } else {
                messageBox.classList.remove('bg-red-800', 'bg-opacity-30', 'border-red-500', 'text-red-200');
                messageBox.classList.add('bg-blue-800', 'bg-opacity-30', 'border-blue-500', 'text-blue-200');
            }
            setTimeout(() => {
                messageBox.classList.add('hidden');
            }, 5000);
        }

        // Initialize Firebase and set up auth listener
        async function initializeFirebase() {
            try {
                if (!firebaseConfig) {
                    console.error("Firebase config is not defined. Cannot initialize the app.");
                    showMessage("Error: Firebase config is missing. Cannot initialize.", true);
                    return;
                }
                
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // Use onAuthStateChanged to ensure we have a user before doing Firestore ops
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("User authenticated:", userId);
                        showMessage("Connected to Firebase successfully!");
                    } else {
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    }
                });
            } catch (error) {
                console.error("Error initializing Firebase:", error);
                showMessage(`Error initializing Firebase: ${error.message}`, true);
            }
        }

        // --- Save Cube State to Firestore ---
        async function saveCubeState() {
            if (!userId) {
                showMessage("Authentication not ready. Please wait a moment.", true);
                return;
            }

            const docId = 'zarraz-state';
            // The path has been changed to a public collection to allow shared data
            const path = `artifacts/${appId}/public/cube-state/${docId}`;
            const docRef = doc(db, path);

            try {
                // Get the current rotation angles of the cube
                const rotation = {
                    x: cube.rotation.x,
                    y: cube.rotation.y,
                    z: cube.rotation.z
                };

                await setDoc(docRef, { 
                    rotation, 
                    lastUpdated: new Date() 
                });
                
                console.log(`Cube state saved to: ${path}`);
                showMessage("Cube state saved to the database!");
            } catch (e) {
                console.error("Error saving document: ", e);
                showMessage(`Error saving state: ${e.message}`, true);
            }
        }

        // --- Load Cube State from Firestore ---
        async function loadCubeState() {
            if (!userId) {
                showMessage("Authentication not ready. Please wait a moment.", true);
                return;
            }

            const docId = 'zarraz-state';
            // The path has been changed to a public collection
            const path = `artifacts/${appId}/public/cube-state/${docId}`;
            const docRef = doc(db, path);

            try {
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    const rotation = data.rotation;
                    
                    // Apply the loaded rotation to the cube
                    cube.rotation.x = rotation.x;
                    cube.rotation.y = rotation.y;
                    cube.rotation.z = rotation.z;

                    console.log("Cube state loaded:", data);
                    showMessage("Cube state loaded from the database!");
                } else {
                    showMessage("No saved cube state found.", true);
                    console.log("No saved state found!");
                }
            } catch (e) {
                console.error("Error loading document: ", e);
                showMessage(`Error loading state: ${e.message}`, true);
            }
        }
        
        // Add event listeners
        saveButton.addEventListener('click', saveCubeState);
        loadButton.addEventListener('click', loadCubeState);

        // Run on window load
        window.onload = function() {
            initializeFirebase();
            initThreeJS();
        }
    </script>
</body>
</html>
